generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Church {
  id                    String                 @id @default(cuid())
  name                  String
  address               String?
  phone                 String?
  email                 String?
  website               String?
  logoUrl               String?
  pastorName            String?
  description           String?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  
  // Existing relations
  attendances           Attendance[]
  departments           Department[]
  expenses              ExpenseReport[]
  members               Member[]
  notificationHistories NotificationHistory[]
  notificationQueues    NotificationQueue[]
  notificationTemplates NotificationTemplate[]
  offerings             Offering[]
  positions             Position[]
  users                 User[]
  visitations           Visitation[]
  
  // New accounting relations
  accountCodes          AccountCode[]
  budgets               Budget[]
  transactions          Transaction[]
  organizations         Organization[]
  organizationRoles     OrganizationRole[]

  @@map("churches")
}

model User {
  id                   String               @id @default(cuid())
  email                String               @unique
  name                 String
  phone                String?
  role                 UserRole             @default(GENERAL_USER)
  isActive             Boolean              @default(true)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  churchId             String
  password             String?
  expenseReports       ExpenseReport[]      @relation("ExpenseRequester")
  notificationSettings NotificationSetting?
  pushSubscription     PushSubscription?
  church               Church               @relation(fields: [churchId], references: [id], onDelete: Cascade)
  
  // Accounting relations
  createdBudgets       Budget[]             @relation("BudgetCreator")
  approvedBudgets      Budget[]             @relation("BudgetApprover")
  createdTransactions  Transaction[]        @relation("TransactionCreator")
  requestedBudgetChanges BudgetChange[]     @relation("BudgetChangeRequester")
  approvedBudgetChanges  BudgetChange[]     @relation("BudgetChangeApprover")
  managedDepartments   Department[]         @relation("DepartmentBudgetManager")
  
  // Approval workflow relations
  assignedApprovalSteps ApprovalStep[]      @relation("ApprovalStepAssignee")
  approvalSteps        ApprovalStep[]       @relation("ApprovalStepApprover")
  
  // Organization relations
  responsibleOrganizations Organization[]   @relation("OrganizationResponsible")

  @@map("users")
}

model Member {
  id               String          @id @default(cuid())
  name             String
  phone            String?
  email            String?
  birthDate        DateTime?
  address          String?
  photoUrl         String?
  gender           Gender?
  maritalStatus    MaritalStatus?
  baptismDate      DateTime?
  confirmationDate DateTime?
  registrationDate DateTime        @default(now())
  status           MemberStatus    @default(ACTIVE)
  familyId         String?
  relationship     FamilyRelation?
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  churchId         String
  positionId       String?
  departmentId     String?
  attendances      Attendance[]
  church           Church          @relation(fields: [churchId], references: [id], onDelete: Cascade)
  department       Department?     @relation(fields: [departmentId], references: [id])
  position         Position?       @relation(fields: [positionId], references: [id])
  
  // 다대다 조직 관계 - 새로운 관계 테이블 사용
  organizationMemberships OrganizationMembership[]
  
  offerings        Offering[]
  visitations      Visitation[]

  @@map("members")
}

model Position {
  id          String   @id @default(cuid())
  name        String
  description String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  churchId    String
  members     Member[]
  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@map("positions")
}

model Department {
  id              String       @id @default(cuid())
  name            String
  description     String?
  leaderId        String?
  parentId        String?
  budgetManagerId String?
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  churchId        String
  church          Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)
  parent          Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children        Department[] @relation("DepartmentHierarchy")
  budgetManager   User?        @relation("DepartmentBudgetManager", fields: [budgetManagerId], references: [id])
  members         Member[]
  budgets         Budget[]

  @@map("departments")
}

model Offering {
  id           String       @id @default(cuid())
  amount       Decimal
  offeringType OfferingType
  description  String?
  offeringDate DateTime     @default(now())
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  churchId     String
  memberId     String
  church       Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)
  member       Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("offerings")
}

model Attendance {
  id             String      @id @default(cuid())
  serviceType    ServiceType
  attendanceDate DateTime    @default(now())
  isPresent      Boolean     @default(true)
  notes          String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  churchId       String
  memberId       String
  church         Church      @relation(fields: [churchId], references: [id], onDelete: Cascade)
  member         Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("attendances")
}

model Visitation {
  id            String            @id @default(cuid())
  visitDate     DateTime
  purpose       VisitationPurpose
  description   String?
  content       String?
  needsFollowUp Boolean           @default(false)
  followUpDate  DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  churchId      String
  memberId      String
  church        Church            @relation(fields: [churchId], references: [id], onDelete: Cascade)
  member        Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("visitations")
}

model ExpenseReport {
  id              String          @id @default(cuid())
  title           String
  description     String?
  amount          Decimal          @db.Decimal(15,2)
  category        ExpenseCategory
  status          ReportStatus    @default(PENDING)
  workflowStatus  WorkflowStatus  @default(DRAFT)
  currentStep     Int             @default(0)
  totalSteps      Int             @default(3)
  requestDate     DateTime        @default(now())
  approvedDate    DateTime?
  rejectedDate    DateTime?
  rejectionReason String?
  receiptUrl      String?
  budgetItemId    String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  churchId        String
  requesterId     String
  organizationId  String?         // 담당 조직 ID
  church          Church          @relation(fields: [churchId], references: [id], onDelete: Cascade)
  requester       User            @relation("ExpenseRequester", fields: [requesterId], references: [id])
  budgetItem      BudgetItem?     @relation("BudgetItemExpenses", fields: [budgetItemId], references: [id])
  organization    Organization?   @relation("OrganizationExpenseReports", fields: [organizationId], references: [id])
  approvals       ApprovalStep[]

  @@map("expense_reports")
}

// 전자결재 승인 단계 모델
model ApprovalStep {
  id              String          @id @default(cuid())
  expenseReportId String
  stepOrder       Int             // 1: 부서회계, 2: 부장, 3: 위원장
  role            UserRole        // 승인자 역할
  assignedUserId  String?         // 지정된 승인자 ID (생성 시 설정)
  approverId      String?         // 실제 승인자 ID (승인 시 설정)
  status          ApprovalStatus  @default(PENDING)
  approvedAt      DateTime?
  rejectedAt      DateTime?
  comment         String?         // 승인/반려 의견
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  expenseReport   ExpenseReport   @relation(fields: [expenseReportId], references: [id], onDelete: Cascade)
  assignedUser    User?           @relation("ApprovalStepAssignee", fields: [assignedUserId], references: [id])
  approver        User?           @relation("ApprovalStepApprover", fields: [approverId], references: [id])
  
  @@unique([expenseReportId, stepOrder])
  @@map("approval_steps")
}

model AccountCode {
  id              String        @id @default(cuid())
  code            String        @unique
  name            String
  englishName     String?
  type            AccountType
  level           Int
  parentId        String?
  order           Int           @default(0)
  allowTransaction Boolean      @default(false)
  isActive        Boolean       @default(true)
  isSystem        Boolean       @default(false)
  description     String?
  churchId        String?       
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  church          Church?       @relation(fields: [churchId], references: [id])
  parent          AccountCode?  @relation("AccountHierarchy", fields: [parentId], references: [id])
  children        AccountCode[] @relation("AccountHierarchy")
  debitTransactions Transaction[] @relation("DebitAccount")
  creditTransactions Transaction[] @relation("CreditAccount")

  @@map("account_codes")
}

model NotificationSetting {
  id                           String   @id @default(cuid())
  userId                       String   @unique
  emailEnabled                 Boolean  @default(true)
  smsEnabled                   Boolean  @default(false)
  pushEnabled                  Boolean  @default(true)
  inAppEnabled                 Boolean  @default(true)
  birthdayNotifications        Boolean  @default(true)
  visitationReminders          Boolean  @default(true)
  expenseApprovalNotifications Boolean  @default(true)
  systemNotifications          Boolean  @default(true)
  birthdayReminderDays         Int      @default(7)
  visitationReminderHours      Int      @default(24)
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt
  user                         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_settings")
}

model NotificationQueue {
  id            String                @id @default(cuid())
  type          NotificationType
  channel       NotificationChannel
  priority      NotificationPriority  @default(NORMAL)
  recipientId   String
  recipientType RecipientType         @default(USER)
  email         String?
  phone         String?
  title         String
  message       String
  templateData  String?
  status        NotificationStatus    @default(PENDING)
  scheduledAt   DateTime?
  sentAt        DateTime?
  failedAt      DateTime?
  errorMessage  String?
  retryCount    Int                   @default(0)
  maxRetries    Int                   @default(3)
  relatedId     String?
  relatedType   String?
  churchId      String
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  history       NotificationHistory[]
  church        Church                @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@index([status, scheduledAt])
  @@index([churchId, status])
  @@map("notification_queue")
}

model NotificationHistory {
  id            String              @id @default(cuid())
  queueId       String?
  type          NotificationType
  channel       NotificationChannel
  recipientId   String
  recipientType RecipientType       @default(USER)
  email         String?
  phone         String?
  title         String
  message       String
  status        NotificationStatus
  sentAt        DateTime?
  errorMessage  String?
  relatedId     String?
  relatedType   String?
  churchId      String
  createdAt     DateTime            @default(now())
  church        Church              @relation(fields: [churchId], references: [id], onDelete: Cascade)
  queue         NotificationQueue?  @relation(fields: [queueId], references: [id])

  @@index([churchId, recipientId])
  @@index([churchId, type])
  @@index([createdAt])
  @@map("notification_history")
}

model NotificationTemplate {
  id        String              @id @default(cuid())
  name      String
  type      NotificationType
  channel   NotificationChannel
  subject   String?
  title     String
  content   String
  isActive  Boolean             @default(true)
  isDefault Boolean             @default(false)
  churchId  String
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt
  church    Church              @relation(fields: [churchId], references: [id], onDelete: Cascade)

  @@unique([churchId, type, channel, name])
  @@map("notification_templates")
}

model PushSubscription {
  id           String   @id @default(cuid())
  userId       String   @unique
  subscription String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("push_subscriptions")
}

enum UserRole {
  SUPER_ADMIN
  FINANCIAL_MANAGER
  MINISTER
  COMMITTEE_CHAIR
  DEPARTMENT_HEAD
  DEPARTMENT_ACCOUNTANT
  BUDGET_MANAGER
  DEPARTMENT_BUDGET
  GENERAL_USER
}

enum Gender {
  MALE
  FEMALE
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  TRANSFERRED
  DECEASED
}

enum FamilyRelation {
  HEAD
  SPOUSE
  CHILD
  PARENT
  SIBLING
  OTHER
}

enum OfferingType {
  TITHE
  THANKSGIVING
  SUNDAY_OFFERING
  SPECIAL
  MISSION
  BUILDING
  OTHER
}

enum ServiceType {
  SUNDAY_MORNING
  SUNDAY_EVENING
  WEDNESDAY
  DAWN
  FRIDAY
  SATURDAY
  SPECIAL
}

enum VisitationPurpose {
  GENERAL
  NEW_FAMILY
  HOSPITAL
  BIRTHDAY
  CONDOLENCE
  COUNSELING
  EVANGELISM
  EVENT
  OTHER
}

enum ExpenseCategory {
  OFFICE
  FACILITY
  EDUCATION
  MISSION
  WELFARE
  EVENT
  OTHER
}

enum ReportStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum AccountType {
  ASSET      // 자산
  LIABILITY  // 부채
  EQUITY     // 자본
  REVENUE    // 수익
  EXPENSE    // 비용
}

enum NotificationType {
  BIRTHDAY_REMINDER
  VISITATION_REMINDER
  EXPENSE_APPROVAL_REQUEST
  EXPENSE_APPROVED
  EXPENSE_REJECTED
  EXPENSE_WORKFLOW_STEP_APPROVAL
  EXPENSE_WORKFLOW_APPROVED
  EXPENSE_WORKFLOW_REJECTED
  SYSTEM_ANNOUNCEMENT
  WELCOME_NEW_MEMBER
  PAYMENT_REMINDER
  CUSTOM
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum NotificationStatus {
  PENDING
  SENDING
  SENT
  FAILED
  CANCELLED
}

enum RecipientType {
  USER
  MEMBER
  GROUP
}

// ===== 회계 시스템 모델 =====

model Budget {
  id           String        @id @default(cuid())
  name         String
  description  String?
  year         Int
  quarter      Int?          // 1-4 분기 (선택)
  month        Int?          // 1-12 월 (선택)
  totalAmount  Decimal       @db.Decimal(15,2)
  status       BudgetStatus  @default(DRAFT)
  startDate    DateTime
  endDate      DateTime
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  // Foreign Keys
  churchId     String
  departmentId String
  organizationId String?      // 담당 조직 ID
  createdById  String
  approvedById String?
  approvedAt   DateTime?
  
  // Relations
  church       Church        @relation(fields: [churchId], references: [id])
  department   Department    @relation(fields: [departmentId], references: [id])
  organization Organization? @relation("OrganizationBudgets", fields: [organizationId], references: [id])
  createdBy    User          @relation("BudgetCreator", fields: [createdById], references: [id])
  approver     User?         @relation("BudgetApprover", fields: [approvedById], references: [id])
  budgetItems  BudgetItem[]
  budgetChanges BudgetChange[]
  
  @@map("budgets")
}

model BudgetItem {
  id              String           @id @default(cuid())
  name            String
  description     String?
  amount          Decimal          @db.Decimal(15,2)
  category        BudgetCategory
  code            String?          // 예산 항목 코드
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Foreign Keys
  budgetId        String
  organizationId  String?          // 담당 조직 ID
  
  // Relations
  budget          Budget           @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  organization    Organization?    @relation("OrganizationBudgetItems", fields: [organizationId], references: [id])
  budgetExecution BudgetExecution?
  expenseReports  ExpenseReport[]  @relation("BudgetItemExpenses")
  
  @@map("budget_items")
}

model BudgetExecution {
  id              String    @id @default(cuid())
  totalBudget     Decimal   @db.Decimal(15,2)
  usedAmount      Decimal   @db.Decimal(15,2) @default(0)
  pendingAmount   Decimal   @db.Decimal(15,2) @default(0)
  remainingAmount Decimal   @db.Decimal(15,2)
  executionRate   Float     @default(0)
  lastUpdated     DateTime  @updatedAt
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Foreign Keys
  budgetItemId    String    @unique
  
  // Relations
  budgetItem      BudgetItem @relation(fields: [budgetItemId], references: [id], onDelete: Cascade)
  
  @@map("budget_executions")
}

model BudgetChange {
  id          String              @id @default(cuid())
  changeType  BudgetChangeType
  amount      Decimal             @db.Decimal(15,2)
  reason      String
  status      BudgetChangeStatus  @default(PENDING)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  
  // Foreign Keys
  budgetId    String
  requestedBy String
  approvedBy  String?
  approvedAt  DateTime?
  fromItemId  String?
  toItemId    String?
  
  // Relations
  budget      Budget              @relation(fields: [budgetId], references: [id])
  requester   User                @relation("BudgetChangeRequester", fields: [requestedBy], references: [id])
  approver    User?               @relation("BudgetChangeApprover", fields: [approvedBy], references: [id])
  
  @@map("budget_changes")
}

model Transaction {
  id              String      @id @default(cuid())
  description     String
  amount          Decimal          @db.Decimal(15,2)
  transactionDate DateTime
  reference       String?     // 참조번호
  voucherNumber   String?     // 전표번호
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Foreign Keys
  debitAccountId  String
  creditAccountId String
  churchId        String
  createdById     String
  
  // Relations
  debitAccount    AccountCode @relation("DebitAccount", fields: [debitAccountId], references: [id])
  creditAccount   AccountCode @relation("CreditAccount", fields: [creditAccountId], references: [id])
  church          Church      @relation(fields: [churchId], references: [id])
  createdBy       User        @relation("TransactionCreator", fields: [createdById], references: [id])
  
  @@map("transactions")
}

// ===== 새로운 열거형 =====

enum BudgetStatus {
  DRAFT      // 초안
  SUBMITTED  // 제출됨
  APPROVED   // 승인됨
  REJECTED   // 반려됨
  ACTIVE     // 활성
  CLOSED     // 마감
}

enum BudgetCategory {
  PERSONNEL   // 인건비
  OPERATIONS  // 운영비
  MANAGEMENT  // 관리비
  FACILITIES  // 시설비
  EDUCATION   // 교육비
  MINISTRY    // 사역비
  MISSION     // 선교비
  WELFARE     // 복지비
  EVENT       // 행사비
  OTHER       // 기타
}

enum BudgetChangeType {
  INCREASE    // 증액
  DECREASE    // 감액
  TRANSFER    // 이체
}

enum BudgetChangeStatus {
  PENDING     // 대기중
  APPROVED    // 승인됨
  REJECTED    // 반려됨
}

// 전자결재 워크플로우 상태
enum WorkflowStatus {
  DRAFT       // 초안
  SUBMITTED   // 제출됨
  IN_PROGRESS // 승인 진행중
  APPROVED    // 최종 승인됨
  REJECTED    // 반려됨
  CANCELLED   // 취소됨
}

// 개별 승인 단계 상태
enum ApprovalStatus {
  PENDING     // 승인 대기
  APPROVED    // 승인됨
  REJECTED    // 반려됨
  SKIPPED     // 생략됨
}

// 조직 단계 레벨 (4단계 구조)
enum OrganizationLevel {
  LEVEL_1     // 1단계: 위원회 (예: 예배찬양위원회)
  LEVEL_2     // 2단계: 부서 (예: 찬양1부)
  LEVEL_3     // 3단계: 팀 (예: 호산나찬양대)
  LEVEL_4     // 4단계: 세부조직 (예: 오케스트라팀)
}

// 조직구조 모델 (자기참조 구조)
model Organization {
  id                String               @id @default(cuid())
  code              String               @unique // 조직코드 (예: "PW-C1-HO-OR")
  name              String               // 조직명
  englishName       String?              // 영문명 (선택사항)
  level             OrganizationLevel    // 조직 단계
  description       String?              // 설명
  isActive          Boolean              @default(true)
  sortOrder         Int                  @default(0) // 정렬 순서
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  
  // 계층구조 관계
  parentId          String?              // 상위 조직 ID
  parent            Organization?        @relation("OrganizationHierarchy", fields: [parentId], references: [id])
  children          Organization[]       @relation("OrganizationHierarchy")
  
  // 교회 관계
  churchId          String
  church            Church               @relation(fields: [churchId], references: [id], onDelete: Cascade)
  
  // 예산 관련 관계
  budgets           Budget[]             @relation("OrganizationBudgets")
  budgetItems       BudgetItem[]         @relation("OrganizationBudgetItems")
  
  // 사용자 관계
  responsibleUsers  User[]               @relation("OrganizationResponsible") // 담당자들
  
  // 다대다 멤버 관계 - 새로운 관계 테이블 사용
  organizationMemberships OrganizationMembership[]
  
  // 지출결의서 관계
  expenseReports    ExpenseReport[]      @relation("OrganizationExpenseReports")

  @@index([churchId, level])
  @@index([churchId, parentId])
  @@index([code])
  @@map("organizations")
}

// ===== 조직-교인 다대다 관계 및 직책 관리 모델 =====

// 조직별 직책 정의 모델
model OrganizationRole {
  id           String   @id @default(cuid())
  name         String   // 직책명 (예: "회장", "서기", "교구장")
  englishName  String?  // 영문 직책명 (선택사항)
  description  String?  // 직책 설명
  level        Int      @default(0) // 직책 레벨 (높을수록 상위 직책)
  sortOrder    Int      @default(0) // 정렬 순서
  isActive     Boolean  @default(true)
  isLeadership Boolean  @default(false) // 리더십 직책 여부
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // 교회 관계 (직책은 교회별로 관리)
  churchId     String
  church       Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  
  // 조직-멤버 관계에서 사용
  memberships  OrganizationMembership[]
  
  @@unique([churchId, name]) // 같은 교회 내에서 직책명 중복 방지
  @@index([churchId, level])
  @@index([churchId, isLeadership])
  @@map("organization_roles")
}

// 조직-교인 다대다 관계 및 직책 정보를 담는 중간 테이블
model OrganizationMembership {
  id               String           @id @default(cuid())
  
  // 기본 관계
  memberId         String
  organizationId   String
  roleId           String?          // 직책 ID (선택사항 - 직책이 없는 일반 멤버도 있을 수 있음)
  
  // 멤버십 정보
  joinDate         DateTime         @default(now()) // 가입일
  endDate          DateTime?        // 종료일 (활성 멤버십은 null)
  isActive         Boolean          @default(true)   // 활성 상태
  isPrimary        Boolean          @default(false)  // 주 소속 조직 여부
  
  // 추가 정보
  notes            String?          // 비고
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  // Relations
  member           Member           @relation(fields: [memberId], references: [id], onDelete: Cascade)
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role             OrganizationRole? @relation(fields: [roleId], references: [id])
  
  @@unique([memberId, organizationId, isActive]) // 한 교인이 같은 조직에서 동시에 활성 멤버십을 하나만 가질 수 있음
  @@index([memberId, isActive])
  @@index([organizationId, isActive])
  @@index([roleId])
  @@index([joinDate])
  @@map("organization_memberships")
}
